'use client';

import { useState, useEffect } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { getStockSignals, getSignalColor } from '@/lib/supabase';
import StockChart from '@/components/StockChart';
import { influencers } from '@/data/influencerData';

interface StockDetailClientProps {
  code: string;
}

// ì¢…ëª©ë³„ íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸
interface StockTimelineEvent {
  id: number;
  type: string;
  icon: string;
  categoryName: string;
  title: string;
  time: string;
  tab: string;
}

const getStockTimeline = (code: string): StockTimelineEvent[] => {
  const timelines: { [key: string]: StockTimelineEvent[] } = {
    '005930': [
      { id: 1, type: 'disclosure', icon: 'ğŸ”µ', categoryName: 'ê³µì‹œ', title: 'Aë“±ê¸‰ ê³µì‹œ - 3ë¶„ê¸° ì‹¤ì  ì»¨ì„¼ì„œìŠ¤ ìƒíšŒ', time: '3ë¶„ ì „', tab: 'disclosure' },
      { id: 2, type: 'influencer', icon: 'ğŸŸ¢', categoryName: 'ì¸í”Œë£¨ì–¸ì„œ', title: 'ìŠˆì¹´ì›”ë“œ ê¸ì • ì‹ í˜¸', time: '1ì‹œê°„ ì „', tab: 'influencer' },
      { id: 3, type: 'report', icon: 'ğŸ“Š', categoryName: 'ë¦¬í¬íŠ¸', title: 'í•œêµ­íˆ¬ìì¦ê¶Œ ëª©í‘œê°€ ìƒí–¥', time: '2ì‹œê°„ ì „', tab: 'reports' },
      { id: 4, type: 'insider', icon: 'ğŸ‘”', categoryName: 'ì„ì›ë§¤ë§¤', title: 'ì´ì¬ìš© ì‚¬ì¥ ë§¤ìˆ˜ 5ë§Œì£¼', time: '3ì‹œê°„ ì „', tab: 'insider' },
      { id: 5, type: 'earnings', icon: 'ğŸ“ˆ', categoryName: 'ì‹¤ì ', title: '3ë¶„ê¸° ì˜ì—…ì´ìµ ì»¨ì„¼ì„œìŠ¤ ìƒíšŒ', time: '5ì‹œê°„ ì „', tab: 'earnings' },
      { id: 6, type: 'influencer', icon: 'ğŸŸ¢', categoryName: 'ì¸í”Œë£¨ì–¸ì„œ', title: 'ì½”ë¦°ì´ì•„ë¹  ë§¤ìˆ˜ ì‹ í˜¸', time: '8ì‹œê°„ ì „', tab: 'influencer' },
      { id: 7, type: 'disclosure', icon: 'ğŸ”µ', categoryName: 'ê³µì‹œ', title: 'ìì‚¬ì£¼ ë§¤ì… ê²°ì •', time: '1ì¼ ì „', tab: 'disclosure' },
    ],
    '005380': [
      { id: 1, type: 'report', icon: 'ğŸ“Š', categoryName: 'ë¦¬í¬íŠ¸', title: 'í•œêµ­íˆ¬ìì¦ê¶Œ ëª©í‘œê°€ ìƒí–¥', time: '2ì‹œê°„ ì „', tab: 'reports' },
      { id: 2, type: 'earnings', icon: 'ğŸ“ˆ', categoryName: 'ì‹¤ì ', title: '3ë¶„ê¸° ì˜ì—…ì´ìµ ì»¨ì„¼ì„œìŠ¤ ìƒíšŒ', time: '5ì‹œê°„ ì „', tab: 'earnings' },
      { id: 3, type: 'disclosure', icon: 'ğŸ”µ', categoryName: 'ê³µì‹œ', title: 'ì „ê¸°ì°¨ ì‹ ëª¨ë¸ ì¶œì‹œ ê³µì‹œ', time: '1ì¼ ì „', tab: 'disclosure' },
    ],
  };
  return timelines[code] || [
    { id: 1, type: 'disclosure', icon: 'ğŸ”µ', categoryName: 'ê³µì‹œ', title: 'ìµœê·¼ ê³µì‹œ ì—†ìŒ', time: '-', tab: 'disclosure' },
  ];
};

// íƒ­ ì •ì˜
const tabs = [
  { id: 'feed', label: 'í”¼ë“œ', icon: 'ğŸ“±' },
  { id: 'influencer', label: 'ì¸í”Œë£¨ì–¸ì„œ', icon: 'ğŸ“ˆ' },
  { id: 'analyst', label: 'ì• ë„ë¦¬ìŠ¤íŠ¸', icon: 'ğŸ“Š' },
  { id: 'disclosure', label: 'ê³µì‹œ', icon: 'ğŸ“‹' },
  { id: 'earnings', label: 'ì‹¤ì ', icon: 'ğŸ“ˆ' },
  { id: 'reports', label: 'ë¦¬í¬íŠ¸', icon: 'ğŸ“„' },
  { id: 'insider', label: 'ì„ì›ë§¤ë§¤', icon: 'ğŸ’¼' },
  { id: 'calendar', label: 'ì¼ì •', icon: 'ğŸ“…' },
  { id: 'memo', label: 'ë©”ëª¨', icon: 'ğŸ“' },
];

// ë”ë¯¸ ì¢…ëª© ë°ì´í„°
const getStockData = (code: string) => {
  const stockMap: { [key: string]: any } = {
    '005930': { name: 'ì‚¼ì„±ì „ì', price: 68500, change: 1200, changePercent: 1.78 },
    '000660': { name: 'SKí•˜ì´ë‹‰ìŠ¤', price: 178000, change: -2100, changePercent: -1.16 },
    '035420': { name: 'NAVER', price: 185500, change: 3200, changePercent: 1.76 },
    '051910': { name: 'LGí™”í•™', price: 412000, change: -5500, changePercent: -1.32 },
    '005380': { name: 'í˜„ëŒ€ì°¨', price: 221000, change: 4500, changePercent: 2.08 },
  };

  return stockMap[code] || { name: `ì¢…ëª© ${code}`, price: 50000, change: 0, changePercent: 0 };
};

export default function StockDetailClient({ code }: StockDetailClientProps) {
  const [activeTab, setActiveTab] = useState('feed');
  const [isWatched, setIsWatched] = useState(false);
  const [showComments, setShowComments] = useState<{ [key: number]: boolean }>({});
  const [commentInputs, setCommentInputs] = useState<{ [key: number]: string }>({});
  const searchParams = useSearchParams();
  const router = useRouter();
  const stockData = getStockData(code);
  const timeline = getStockTimeline(code);

  // URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ íƒ­ ì„¤ì •
  useEffect(() => {
    const tabParam = searchParams.get('tab');
    if (tabParam && tabs.some(tab => tab.id === tabParam)) {
      setActiveTab(tabParam);
    }
  }, [searchParams]);

  // í•´ë‹¹ ì¢…ëª©ì˜ ì‹œê·¸ë„ ê°€ì ¸ì˜¤ê¸°
  const getStockSignalsLocal = (code: string, name: string) => {
    const stockMapping: { [key: string]: string[] } = {
      '005930': ['ì‚¼ì„±ì „ì', 'ì‚¼ì„±'],
      '000660': ['SKí•˜ì´ë‹‰ìŠ¤', 'í•˜ì´ë‹‰ìŠ¤'],
      '035420': ['ë„¤ì´ë²„', 'NAVER'],
      '051910': ['LGí™”í•™'],
      '005380': ['í˜„ëŒ€ì°¨', 'í˜„ëŒ€ìë™ì°¨'],
      '005490': ['POSCOí™€ë”©ìŠ¤', 'í¬ìŠ¤ì½”'],
      'BTC': ['ë¹„íŠ¸ì½”ì¸', 'Bitcoin'],
      'ETH': ['ì´ë”ë¦¬ì›€', 'Ethereum']
    };

    const possibleNames = stockMapping[code] || [name];
    const signals: any[] = [];
    
    influencers.forEach(influencer => {
      influencer.recentCalls.forEach(call => {
        const isMatch = possibleNames.some(stockName => 
          call.stock.includes(stockName) || stockName.includes(call.stock)
        );
        
        if (isMatch) {
          signals.push({
            id: `${influencer.id}-${call.stock}`,
            stock: call.stock,
            signal_type: call.direction,
            speaker: influencer.name,
            content_snippet: `${call.stock} ${call.direction} ì¶”ì²œ`,
            date: call.date,
            video_published_at: call.date,
            accuracy_rate: influencer.accuracy,
            return_rate: call.returnRate,
            status: call.status
          });
        }
      });
    });
    
    return signals;
  };

  const stockSignals = getStockSignalsLocal(code, stockData.name);

  const renderTabContent = () => {
    switch (activeTab) {
      case 'feed':
        return (
          <div className="space-y-6">
            {/* ì£¼ê°€ ì°¨íŠ¸ */}
            <StockChart 
              stockCode={code}
              stockName={stockData.name}
              signals={stockSignals}
            />
            
            {/* íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ */}
            <div className="space-y-4">
            {timeline.map((event) => (
              <div key={event.id} className="bg-white rounded-lg border border-[#e8e8e8] overflow-hidden">
                <div
                  onClick={() => setActiveTab(event.tab)}
                  className="px-4 py-4 hover:bg-[#f8f9fa] cursor-pointer transition-colors"
                >
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-[#f8f9fa] flex items-center justify-center text-lg flex-shrink-0">
                      {event.icon}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="text-sm font-medium text-[#8b95a1] bg-[#f2f4f6] px-2 py-0.5 rounded">
                          {event.categoryName}
                        </span>
                      </div>
                      <h3 className="text-[15px] font-medium text-[#191f28] leading-[1.4] mb-1">
                        {event.title}
                      </h3>
                      <span className="text-sm text-[#8b95a1]">{event.time}</span>
                    </div>
                    <div className="text-[#8b95a1] text-sm">â†’</div>
                  </div>
                </div>
                
                {/* Comment Section */}
                <div className="border-t border-[#f0f0f0] px-4 py-3">
                  <div className="flex items-center gap-2 mb-2">
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowComments(prev => ({
                          ...prev,
                          [event.id]: !prev[event.id]
                        }));
                      }}
                      className="text-xs text-[#8b95a1] hover:text-[#191f28] transition-colors"
                    >
                      ğŸ’¬ ëŒ“ê¸€ {Math.floor(Math.random() * 10) + 1}ê°œ
                    </button>
                    <span className="text-xs text-[#8b95a1]">â€¢</span>
                    <button className="text-xs text-[#8b95a1] hover:text-[#191f28] transition-colors">
                      â¤ï¸ ì¢‹ì•„ìš” {Math.floor(Math.random() * 50) + 5}ê°œ
                    </button>
                  </div>
                  
                  {/* Comment Input */}
                  <div className="flex gap-2">
                    <div className="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center text-xs flex-shrink-0">
                      ğŸ‘¤
                    </div>
                    <input
                      type="text"
                      placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                      value={commentInputs[event.id] || ''}
                      onChange={(e) => {
                        setCommentInputs(prev => ({
                          ...prev,
                          [event.id]: e.target.value
                        }));
                      }}
                      onClick={(e) => e.stopPropagation()}
                      className="flex-1 text-sm border border-[#e8e8e8] rounded-full px-3 py-1 focus:outline-none focus:ring-1 focus:ring-[#3182f6] focus:border-transparent"
                    />
                    <button 
                      onClick={(e) => {
                        e.stopPropagation();
                        if (commentInputs[event.id]?.trim()) {
                          // Here you would handle comment submission
                          setCommentInputs(prev => ({
                            ...prev,
                            [event.id]: ''
                          }));
                        }
                      }}
                      className="text-xs px-3 py-1 bg-[#3182f6] text-white rounded-full hover:bg-[#2171e5] transition-colors"
                    >
                      ë“±ë¡
                    </button>
                  </div>
                  
                  {/* Comments List */}
                  {showComments[event.id] && (
                    <div className="mt-3 space-y-2 pl-8">
                      <div className="flex gap-2 text-sm">
                        <div className="w-5 h-5 bg-green-100 rounded-full flex items-center justify-center text-xs flex-shrink-0">
                          ğŸ¶
                        </div>
                        <div>
                          <span className="font-medium text-[#191f28]">íˆ¬ìì™•</span>
                          <span className="text-[#8b95a1] ml-2">ì¢‹ì€ ì •ë³´ë„¤ìš”!</span>
                        </div>
                      </div>
                      <div className="flex gap-2 text-sm">
                        <div className="w-5 h-5 bg-yellow-100 rounded-full flex items-center justify-center text-xs flex-shrink-0">
                          ğŸ¯
                        </div>
                        <div>
                          <span className="font-medium text-[#191f28]">ì£¼ì‹ì´ˆë³´</span>
                          <span className="text-[#8b95a1] ml-2">ë§¤ìˆ˜ íƒ€ì´ë° ë§ë‚˜ìš”?</span>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            ))}
            </div>
          </div>
        );

      case 'influencer':
        return <InfluencerTab code={code} />;

      case 'analyst':
        return <AnalystTab code={code} />;

      case 'disclosure':
        return (
          <div className="space-y-4">
            <div className="bg-white rounded-lg border border-[#e8e8e8] p-6">
              <h4 className="font-bold text-[#191f28] mb-4">ìµœê·¼ ê³µì‹œ</h4>
              <div className="space-y-3">
                <div className="p-3 border-l-4 border-blue-500 bg-blue-50">
                  <div className="font-medium text-blue-800">3ë¶„ê¸° ì‹¤ì  ë°œí‘œ</div>
                  <div className="text-sm text-blue-600">2ì‹œê°„ ì „</div>
                </div>
                <div className="p-3 border-l-4 border-green-500 bg-green-50">
                  <div className="font-medium text-green-800">ìì‚¬ì£¼ ë§¤ì… ê²°ì •</div>
                  <div className="text-sm text-green-600">1ì¼ ì „</div>
                </div>
              </div>
            </div>
          </div>
        );

      case 'earnings':
        return (
          <div className="text-center py-12">
            <div className="text-4xl mb-4">ğŸ“Š</div>
            <h3 className="text-lg font-bold text-[#191f28] mb-2">ì‹¤ì  ë¶„ì„</h3>
            <p className="text-[#8b95a1]">ìƒì„¸ ì‹¤ì  ë¶„ì„ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤</p>
          </div>
        );

      case 'reports':
        return (
          <div className="text-center py-12">
            <div className="text-4xl mb-4">ğŸ“„</div>
            <h3 className="text-lg font-bold text-[#191f28] mb-2">ë¦¬ì„œì¹˜ ë¦¬í¬íŠ¸</h3>
            <p className="text-[#8b95a1]">ì¦ê¶Œì‚¬ ë¦¬í¬íŠ¸ë¥¼ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤</p>
          </div>
        );

      case 'insider':
        return (
          <div className="space-y-4">
            <div className="bg-white rounded-lg border border-[#e8e8e8] p-6">
              <h4 className="font-bold text-[#191f28] mb-4">ì„ì› ë§¤ë§¤ í˜„í™©</h4>
              <div className="space-y-3">
                <div className="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                  <div>
                    <div className="font-medium text-red-800">ê¹€â—‹â—‹ ì „ë¬´ ë§¤ë„</div>
                    <div className="text-sm text-red-600">5ì–µì› ê·œëª¨ â€¢ 3ì¼ ì „</div>
                  </div>
                  <div className="text-red-600 font-bold">-1.2%</div>
                </div>
                <div className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                  <div>
                    <div className="font-medium text-blue-800">ë°•â—‹â—‹ ìƒë¬´ ë§¤ìˆ˜</div>
                    <div className="text-sm text-blue-600">3ì–µì› ê·œëª¨ â€¢ 1ì£¼ ì „</div>
                  </div>
                  <div className="text-blue-600 font-bold">+0.8%</div>
                </div>
              </div>
            </div>
          </div>
        );

      case 'calendar':
        return (
          <div className="text-center py-12">
            <div className="text-4xl mb-4">ğŸ“…</div>
            <h3 className="text-lg font-bold text-[#191f28] mb-2">ì¢…ëª© ì¼ì •</h3>
            <p className="text-[#8b95a1]">ì‹¤ì ë°œí‘œ, ì£¼ì£¼ì´íšŒ ë“± ì¼ì •ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤</p>
          </div>
        );

      case 'memo':
        return (
          <div className="bg-white rounded-lg border border-[#e8e8e8] p-6">
            <h4 className="font-bold text-[#191f28] mb-4">ë‚´ ë©”ëª¨</h4>
            <div className="space-y-4">
              <textarea
                placeholder="ì´ ì¢…ëª©ì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”..."
                className="w-full h-32 p-3 border border-[#e8e8e8] rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-[#3182f6] focus:border-transparent"
              />
              <div className="flex justify-end">
                <button className="px-4 py-2 bg-[#3182f6] text-white rounded-lg hover:bg-[#2171e5] transition-colors">
                  ì €ì¥
                </button>
              </div>
            </div>
          </div>
        );

      default:
        return <div>ì¤€ë¹„ì¤‘</div>;
    }
  };

  return (
    <div className="min-h-screen bg-[#f4f4f4]">
      {/* Stock Header */}
      <div className="bg-white border-b border-[#e8e8e8] px-4 py-6">
        <div>
          {/* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */}
          <div className="mb-4">
            <button
              onClick={() => router.push('/my-stocks')}
              className="flex items-center gap-2 text-[#8b95a1] hover:text-[#191f28] transition-colors"
            >
              <span className="text-lg">â†</span>
              <span className="text-sm">ë‚´ ì¢…ëª©ìœ¼ë¡œ</span>
            </button>
          </div>

          <div className="flex justify-between items-start">
            <div>
              <h1 className="text-2xl font-bold text-[#191f28]">
                {stockData.name}
                <span className="text-lg text-[#8b95a1] font-normal ml-2">
                  {code}
                </span>
              </h1>
              <div className="flex items-center gap-4 mt-2">
                <span className="text-3xl font-bold text-[#191f28]">
                  {stockData.price.toLocaleString()}ì›
                </span>
                <span className={`text-lg font-medium ${
                  stockData.change >= 0 ? 'text-red-500' : 'text-blue-500'
                }`}>
                  {stockData.change >= 0 ? '+' : ''}{stockData.change.toLocaleString()}ì›
                  ({stockData.change >= 0 ? '+' : ''}{stockData.changePercent}%)
                </span>
              </div>
              
              {/* Coverage Stats */}
              <div className="flex items-center gap-4 mt-3 text-sm text-[#8b95a1]">
                <span>ì¸í”Œë£¨ì–¸ì„œ 12ëª…</span>
                <span>â€¢</span>
                <span>ì• ë„ë¦¬ìŠ¤íŠ¸ 8ëª…</span>
                <span>â€¢</span>
                <span>íˆ¬ìì 5ëª…</span>
                <span>â€¢</span>
                <span>íŒ”ë¡œì›Œ 3,247ëª…</span>
              </div>
            </div>
            
            {/* Watch Button */}
            <button
              onClick={() => setIsWatched(!isWatched)}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                isWatched
                  ? 'bg-green-100 text-green-700 border border-green-200'
                  : 'bg-[#3182f6] text-white hover:bg-[#2171e5]'
              }`}
            >
              {isWatched ? 'âœ“ ê´€ì‹¬ì¢…ëª© ë“±ë¡ë¨' : '+ ê´€ì‹¬ì¢…ëª© ì¶”ê°€'}
            </button>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div className="bg-white border-b border-[#e8e8e8]">
        <div className="px-4">
          <div className="flex overflow-x-auto scrollbar-hide">
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`flex-shrink-0 flex items-center gap-2 px-4 py-3 text-sm font-medium transition-colors relative ${
                  activeTab === tab.id
                    ? 'text-[#3182f6]'
                    : 'text-[#8b95a1] hover:text-[#191f28]'
                }`}
              >
                {tab.label}
                {activeTab === tab.id && (
                  <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-[#3182f6]" />
                )}
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Content */}
      <div className="px-4 py-6">
        {renderTabContent()}
      </div>
    </div>
  );
}

// ì¸í”Œë£¨ì–¸ì„œ íƒ­ ì»´í¬ë„ŒíŠ¸ (ê°œì„ ëœ ì°¨íŠ¸ + ëª¨ë“  ì‹œê·¸ë„ ì  í‘œì‹œ)
function InfluencerTab({ code }: { code: string }) {
  const [periodFilter, setPeriodFilter] = useState('ì „ì²´');
  const [influencerFilter, setInfluencerFilter] = useState('ì „ì²´');
  const [signalData, setSignalData] = useState<any[]>([]);
  const [influencerOptions, setInfluencerOptions] = useState([
    { name: 'ì „ì²´', count: null }
  ]);
  const [loading, setLoading] = useState(true);

  const periodOptions = ['1ê°œì›”', '6ê°œì›”', '1ë…„', '3ë…„', 'ì „ì²´'];

  // ë°ì´í„° ë¡œë“œ
  useEffect(() => {
    const loadData = async () => {
      try {
        setLoading(true);
        
        const { getStockSignals } = await import('@/lib/supabase');
        const signals = await getStockSignals(code);
        
        // ë°ì´í„°ë¥¼ UIìš© í˜•íƒœë¡œ ë³€í™˜
        const transformedSignals = signals.map((signal: any) => {
          const publishedDate = signal.influencer_videos?.published_at 
            ? new Date(signal.influencer_videos.published_at)
            : new Date();
          
          const videoUrl = signal.influencer_videos?.video_id 
            ? `https://youtube.com/watch?v=${signal.influencer_videos.video_id}`
            : '#';

          const speakerName = signal.speakers?.name || '';
          const channelName = signal.influencer_videos?.influencer_channels?.channel_name || '';
          // ê²ŒìŠ¤íŠ¸ë©´ "ìŠ¤í”¼ì»¤ Â· ì±„ë„", í˜¸ìŠ¤íŠ¸(ìŠ¤í”¼ì»¤==ì±„ë„ or ìŠ¤í”¼ì»¤ ì—†ìŒ)ë©´ ì±„ë„ëª…ë§Œ
          const influencerDisplay = speakerName && speakerName !== channelName
            ? `${speakerName} Â· ${channelName}`
            : channelName || speakerName || 'Unknown';

          return {
            date: publishedDate.toISOString().split('T')[0],
            influencer: influencerDisplay,
            signal: signal.signal,
            quote: signal.key_quote || 'í‚¤ ì¸ìš©ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.',
            return: 'N/A', // TODO: ìˆ˜ìµë¥  ê³„ì‚°
            videoUrl,
            price: 0, // TODO: ë°œì–¸ ì‹œì  ì£¼ê°€
            timestamp: signal.timestamp
          };
        });
        
        // published_at ìš°ì„  ìµœì‹ ìˆœ ì •ë ¬
        transformedSignals.sort((a: any, b: any) => (b.date || '').localeCompare(a.date || ''));
        setSignalData(transformedSignals);
        
        // ì¸í”Œë£¨ì–¸ì„œë³„ ì¹´ìš´íŠ¸ ìƒì„±
        const influencerCounts = transformedSignals.reduce((acc: any, signal: any) => {
          acc[signal.influencer] = (acc[signal.influencer] || 0) + 1;
          return acc;
        }, {});
        
        const influencerOpts = [
          { name: 'ì „ì²´', count: null },
          ...Object.entries(influencerCounts).map(([name, count]) => ({
            name,
            count: count as number
          }))
        ];
        
        setInfluencerOptions(influencerOpts);
      } catch (error) {
        console.error('Error loading stock signals:', error);
        setSignalData([]);
      } finally {
        setLoading(false);
      }
    };

    if (code) {
      loadData();
    }
  }, [code]);

  const getLocalSignalColor = (signal: string) => {
    switch (signal) {
      case 'ë§¤ìˆ˜':
      case 'BUY': return 'text-blue-600 bg-blue-100';
      case 'ê¸ì •':
      case 'POSITIVE': return 'text-green-600 bg-green-100';
      case 'ì¤‘ë¦½':
      case 'NEUTRAL': return 'text-yellow-600 bg-yellow-100';
      case 'ê²½ê³„':
      case 'CONCERN': return 'text-orange-600 bg-orange-100';
      case 'ë§¤ë„':
      case 'SELL': return 'text-red-600 bg-red-100';
      default: return 'text-gray-600 bg-gray-100';
    }
  };

  const getSignalEmoji = (signal: string) => {
    switch (signal) {
      case 'ë§¤ìˆ˜':
      case 'BUY': return 'ğŸ”µ';
      case 'ê¸ì •':
      case 'POSITIVE': return 'ğŸŸ¢';
      case 'ì¤‘ë¦½':
      case 'NEUTRAL': return 'ğŸŸ¡';
      case 'ê²½ê³„':
      case 'CONCERN': return 'ğŸŸ ';
      case 'ë§¤ë„':
      case 'SELL': return 'ğŸ”´';
      default: return 'âšª';
    }
  };

  const getSignalPointColor = (signal: string) => {
    switch (signal) {
      case 'ë§¤ìˆ˜':
      case 'BUY': return '#3B82F6'; // blue-500
      case 'ê¸ì •':
      case 'POSITIVE': return '#10B981'; // green-500
      case 'ì¤‘ë¦½':
      case 'NEUTRAL': return '#F59E0B'; // yellow-500
      case 'ê²½ê³„':
      case 'CONCERN': return '#F97316'; // orange-500
      case 'ë§¤ë„':
      case 'SELL': return '#EF4444'; // red-500
      default: return '#6B7280'; // gray-500
    }
  };

  const getSignalText = (signal: string) => {
    return signal;
  };

  // í•„í„°ë§ëœ ë°ì´í„° ê³„ì‚°
  const getFilteredSignals = () => {
    let filtered = [...signalData];
    
    // ì¸í”Œë£¨ì–¸ì„œ í•„í„°
    if (influencerFilter !== 'ì „ì²´') {
      filtered = filtered.filter(signal => signal.influencer === influencerFilter);
    }
    
    // ê¸°ê°„ í•„í„°
    if (periodFilter !== 'ì „ì²´') {
      const now = new Date();
      let cutoffDate = new Date();
      
      switch (periodFilter) {
        case '1ê°œì›”':
          cutoffDate.setMonth(now.getMonth() - 1);
          break;
        case '6ê°œì›”':
          cutoffDate.setMonth(now.getMonth() - 6);
          break;
        case '1ë…„':
          cutoffDate.setFullYear(now.getFullYear() - 1);
          break;
        case '3ë…„':
          cutoffDate.setFullYear(now.getFullYear() - 3);
          break;
      }
      
      filtered = filtered.filter(signal => new Date(signal.date) >= cutoffDate);
    }
    
    return filtered;
  };

  const filteredSignals = getFilteredSignals();

  // ì°¨íŠ¸ìš© ë°ì´í„° ìƒì„± (ê°œì„ ëœ ì°¨íŠ¸)
  const generateChartData = () => {
    const chartWidth = 400;
    const chartHeight = 200;
    const padding = 20;
    
    // ë”ë¯¸ ì£¼ê°€ ë°ì´í„° (ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´ í•„ìš”)
    const priceData = Array.from({ length: 30 }, (_, i) => ({
      x: (i / 29) * (chartWidth - 2 * padding) + padding,
      y: Math.sin(i * 0.2) * 30 + chartHeight / 2 + Math.random() * 20 - 10
    }));
    
    // ì‹œê·¸ë„ ì ë“¤ (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)
    const signalPoints = filteredSignals.map((signal, index) => {
      const x = (index / Math.max(filteredSignals.length - 1, 1)) * (chartWidth - 2 * padding) + padding;
      const y = Math.random() * (chartHeight - 2 * padding) + padding;
      return {
        x,
        y,
        signal: signal.signal,
        influencer: signal.influencer,
        date: signal.date
      };
    });
    
    return { priceData, signalPoints };
  };

  const { priceData, signalPoints } = generateChartData();

  if (loading) {
    return (
      <div className="text-center py-8">
        <div className="text-lg text-[#8b95a1]">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* í•„í„° ì„¹ì…˜ */}
      <div className="bg-white rounded-lg border border-[#e8e8e8] p-6">
        <div className="space-y-4">
          <div>
            <h4 className="font-medium text-[#191f28] mb-3">ê¸°ê°„</h4>
            <div className="flex gap-2 flex-wrap">
              {periodOptions.map((period) => (
                <button
                  key={period}
                  onClick={() => setPeriodFilter(period)}
                  className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                    periodFilter === period
                      ? 'bg-[#3182f6] text-white'
                      : 'bg-[#f8f9fa] text-[#8b95a1] hover:bg-[#e9ecef]'
                  }`}
                >
                  {period}
                </button>
              ))}
            </div>
          </div>

          <div>
            <h4 className="font-medium text-[#191f28] mb-3">ì¸í”Œë£¨ì–¸ì„œ</h4>
            <div className="flex gap-2 flex-wrap">
              {influencerOptions.map((option) => (
                <button
                  key={option.name}
                  onClick={() => setInfluencerFilter(option.name)}
                  className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                    influencerFilter === option.name
                      ? 'bg-[#3182f6] text-white'
                      : 'bg-[#f8f9fa] text-[#8b95a1] hover:bg-[#e9ecef]'
                  }`}
                >
                  {option.name}
                  {option.count && `(${option.count})`}
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* ê°œì„ ëœ ì°¨íŠ¸ ì˜ì—­ */}
      <div className="bg-white rounded-lg border border-[#e8e8e8] p-6">
        <h4 className="font-medium text-[#191f28] mb-4">ì£¼ê°€ ì°¨íŠ¸ & ì¸í”Œë£¨ì–¸ì„œ ì‹ í˜¸ ({filteredSignals.length}ê°œ)</h4>
        <div className="relative h-80 bg-[#f8f9fa] rounded-lg overflow-hidden">
          <svg className="w-full h-full" viewBox="0 0 400 200">
            {/* ë°°ê²½ ê²©ì */}
            <defs>
              <pattern id="influencerGrid" width="40" height="20" patternUnits="userSpaceOnUse">
                <path d="M 40 0 L 0 0 0 20" fill="none" stroke="#e8e8e8" strokeWidth="1"/>
              </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#influencerGrid)" />
            
            {/* ì£¼ê°€ ë¼ì¸ (ë” ë¶€ë“œëŸ¬ìš´ ê³¡ì„ ) */}
            <path
              d={`M ${priceData.map(p => `${p.x} ${p.y}`).join(' L ')}`}
              fill="none"
              stroke="#3182f6"
              strokeWidth="2"
              opacity="0.8"
            />
            
            {/* ëª¨ë“  ì‹œê·¸ë„ ì ë“¤ í‘œì‹œ */}
            {signalPoints.map((point, index) => (
              <g key={index}>
                <circle 
                  cx={point.x} 
                  cy={point.y} 
                  r="8" 
                  fill={getSignalPointColor(point.signal)} 
                  stroke="white" 
                  strokeWidth="2"
                  className="cursor-pointer"
                />
                {/* í˜¸ë²„ ì‹œ ì •ë³´ í‘œì‹œ */}
                <title>
                  {point.influencer} - {getSignalText(point.signal)} ({point.date})
                </title>
              </g>
            ))}
            
            {/* Yì¶• ë¼ë²¨ */}
            <text x="10" y="20" className="text-xs fill-gray-600">ë†’ìŒ</text>
            <text x="10" y="190" className="text-xs fill-gray-600">ë‚®ìŒ</text>
          </svg>
          
          {/* ë²”ë¡€ (ê°œì„ ë¨) */}
          <div className="absolute top-3 right-3 bg-white/90 backdrop-blur-sm rounded-lg p-4 text-xs">
            <div className="font-medium mb-2">ì‹œê·¸ë„ íƒ€ì…</div>
            <div className="grid grid-cols-2 gap-1">
              <span className="flex items-center gap-1"><span className="w-2 h-2 bg-blue-500 rounded-full"></span>ë§¤ìˆ˜</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 bg-green-500 rounded-full"></span>ê¸ì •</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 bg-yellow-500 rounded-full"></span>ì¤‘ë¦½</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 bg-orange-500 rounded-full"></span>ê²½ê³„</span>
              <span className="flex items-center gap-1"><span className="w-2 h-2 bg-red-500 rounded-full"></span>ë§¤ë„</span>
            </div>
            <div className="mt-2 text-gray-600">
              ì´ {filteredSignals.length}ê°œ ì‹œê·¸ë„
            </div>
          </div>
        </div>
      </div>

      {/* ì‹ í˜¸ í…Œì´ë¸” */}
      <div className="bg-white rounded-lg border border-[#e8e8e8] overflow-hidden">
        <div className="p-6 border-b border-[#e8e8e8]">
          <h4 className="font-medium text-[#191f28]">ì¸í”Œë£¨ì–¸ì„œ ì‹ í˜¸ ì´ë ¥</h4>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-[#f8f9fa]">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ë‚ ì§œ</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ì¸í”Œë£¨ì–¸ì„œ</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ì‹ í˜¸</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">í•µì‹¬ë°œì–¸</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ìˆ˜ìµë¥ </th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ì˜ìƒë§í¬</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[#f0f0f0]">
              {filteredSignals.map((signal, index) => (
                <tr key={index} className="hover:bg-[#f8f9fa]">
                  <td className="px-4 py-4 text-sm text-[#191f28]">
                    {new Date(signal.date).toLocaleDateString('ko-KR', { 
                      month: 'short', 
                      day: 'numeric' 
                    })}
                  </td>
                  <td className="px-4 py-4 text-sm text-[#191f28] whitespace-nowrap">
                    {signal.influencer}
                  </td>
                  <td className="px-4 py-4">
                    <div className="flex items-center gap-2">
                      <span className="text-lg">{getSignalEmoji(signal.signal)}</span>
                      <span className={`px-2 py-1 rounded text-xs font-medium ${getLocalSignalColor(signal.signal)}`}>
                        {getSignalText(signal.signal)}
                      </span>
                    </div>
                  </td>
                  <td className="px-4 py-4 text-sm text-[#191f28] max-w-xs">
                    <div className="truncate" title={signal.quote}>{signal.quote}</div>
                  </td>
                  <td className="px-4 py-4 text-sm font-medium">
                    <span className="text-gray-500">
                      {signal.return}
                    </span>
                  </td>
                  <td className="px-4 py-4">
                    <a
                      href={signal.videoUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-[#3182f6] hover:text-[#2171e5] text-sm font-medium"
                    >
                      ì˜ìƒë³´ê¸° â†’
                    </a>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// ì• ë„ë¦¬ìŠ¤íŠ¸ íƒ­ ì»´í¬ë„ŒíŠ¸ (ì°¨íŠ¸ í˜•íƒœ)
function AnalystTab({ code }: { code: string }) {
  const [periodFilter, setPeriodFilter] = useState('ì „ì²´');
  const [analystFilter, setAnalystFilter] = useState('ì „ì²´');
  
  const periodOptions = ['1ê°œì›”', '6ê°œì›”', '1ë…„', '3ë…„', 'ì „ì²´'];
  
  // ë”ë¯¸ ì• ë„ë¦¬ìŠ¤íŠ¸ ë°ì´í„° (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” DBì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨)
  const analystSignals = [
    {
      date: '2024-02-20',
      analyst: 'ê¹€ì„ ìš°',
      firm: 'í•œêµ­íˆ¬ìì¦ê¶Œ',
      signal: 'ë§¤ìˆ˜',
      targetPrice: '75,000ì›',
      quote: 'ë©”ëª¨ë¦¬ ì—…ì‚¬ì´í´ ì‹œì‘ìœ¼ë¡œ ì‹¤ì  ê°œì„  ê¸°ëŒ€',
      accuracy: '72%',
      previousPrice: '68,500ì›',
      upside: '+9.5%'
    },
    {
      date: '2024-02-18',
      analyst: 'ì´ë¯¸ë˜',
      firm: 'ë¯¸ë˜ì—ì…‹ì¦ê¶Œ',
      signal: 'ë§¤ìˆ˜',
      targetPrice: '72,000ì›',
      quote: '3ë¶„ê¸° ì‹¤ì  ì»¨ì„¼ì„œìŠ¤ ìƒíšŒ ì „ë§',
      accuracy: '68%',
      previousPrice: '68,500ì›',
      upside: '+5.1%'
    },
    {
      date: '2024-02-15',
      analyst: 'ë°•ê¸°ìˆ ',
      firm: 'NHíˆ¬ìì¦ê¶Œ',
      signal: 'ì¤‘ë¦½',
      targetPrice: '65,000ì›',
      quote: 'ë‹¨ê¸° ì¡°ì • í›„ ìƒìŠ¹ ì „ë§',
      accuracy: '65%',
      previousPrice: '68,500ì›',
      upside: '-5.1%'
    },
    {
      date: '2024-02-10',
      analyst: 'ì •ì—ë„ˆì§€',
      firm: 'ì‚¼ì„±ì¦ê¶Œ',
      signal: 'ë§¤ìˆ˜',
      targetPrice: '78,000ì›',
      quote: 'AI ë°˜ë„ì²´ ìˆ˜ìš” ì¦ê°€ë¡œ ìˆ˜í˜œ',
      accuracy: '74%',
      previousPrice: '68,500ì›',
      upside: '+13.9%'
    },
    {
      date: '2024-02-05',
      analyst: 'ìµœê¸ˆìœµ',
      firm: 'KBì¦ê¶Œ',
      signal: 'ê¸ì •',
      targetPrice: '70,000ì›',
      quote: 'HBM ì ìœ ìœ¨ í™•ëŒ€ ì§€ì†',
      accuracy: '69%',
      previousPrice: '68,500ì›',
      upside: '+2.2%'
    }
  ];

  const analystOptions = [
    { name: 'ì „ì²´', count: null },
    { name: 'í•œêµ­íˆ¬ìì¦ê¶Œ', count: 1 },
    { name: 'ë¯¸ë˜ì—ì…‹ì¦ê¶Œ', count: 1 },
    { name: 'NHíˆ¬ìì¦ê¶Œ', count: 1 },
    { name: 'ì‚¼ì„±ì¦ê¶Œ', count: 1 },
    { name: 'KBì¦ê¶Œ', count: 1 }
  ];

  const getSignalColor = (signal: string) => {
    switch (signal) {
      case 'ë§¤ìˆ˜': return 'text-blue-600 bg-blue-100';
      case 'ê¸ì •': return 'text-green-600 bg-green-100';
      case 'ì¤‘ë¦½': return 'text-yellow-600 bg-yellow-100';
      case 'ê²½ê³„': return 'text-orange-600 bg-orange-100';
      case 'ë§¤ë„': return 'text-red-600 bg-red-100';
      default: return 'text-gray-600 bg-gray-100';
    }
  };

  const getSignalEmoji = (signal: string) => {
    switch (signal) {
      case 'ë§¤ìˆ˜': return 'ğŸ”µ';
      case 'ê¸ì •': return 'ğŸŸ¢';
      case 'ì¤‘ë¦½': return 'ğŸŸ¡';
      case 'ê²½ê³„': return 'ğŸŸ ';
      case 'ë§¤ë„': return 'ğŸ”´';
      default: return 'âšª';
    }
  };

  const getTargetPriceColor = (firm: string) => {
    const colors: { [key: string]: string } = {
      'í•œêµ­íˆ¬ìì¦ê¶Œ': '#3B82F6',
      'ë¯¸ë˜ì—ì…‹ì¦ê¶Œ': '#10B981',
      'NHíˆ¬ìì¦ê¶Œ': '#F59E0B',
      'ì‚¼ì„±ì¦ê¶Œ': '#EF4444',
      'KBì¦ê¶Œ': '#8B5CF6'
    };
    return colors[firm] || '#6B7280';
  };

  // í•„í„°ë§ëœ ë°ì´í„°
  const filteredSignals = analystSignals.filter(signal => {
    if (analystFilter !== 'ì „ì²´' && !signal.firm.includes(analystFilter.replace('ì¦ê¶Œ', ''))) {
      return false;
    }
    
    if (periodFilter !== 'ì „ì²´') {
      const now = new Date();
      let cutoffDate = new Date();
      
      switch (periodFilter) {
        case '1ê°œì›”':
          cutoffDate.setMonth(now.getMonth() - 1);
          break;
        case '6ê°œì›”':
          cutoffDate.setMonth(now.getMonth() - 6);
          break;
        case '1ë…„':
          cutoffDate.setFullYear(now.getFullYear() - 1);
          break;
        case '3ë…„':
          cutoffDate.setFullYear(now.getFullYear() - 3);
          break;
      }
      
      if (new Date(signal.date) < cutoffDate) {
        return false;
      }
    }
    
    return true;
  });

  // í‰ê·  ëª©í‘œê°€ ê³„ì‚°
  const avgTargetPrice = filteredSignals.reduce((sum, signal) => {
    return sum + parseInt(signal.targetPrice.replace(/[,ì›]/g, ''));
  }, 0) / filteredSignals.length;

  return (
    <div className="space-y-6">
      {/* í•„í„° ì„¹ì…˜ */}
      <div className="bg-white rounded-lg border border-[#e8e8e8] p-6">
        <div className="space-y-4">
          <div>
            <h4 className="font-medium text-[#191f28] mb-3">ê¸°ê°„</h4>
            <div className="flex gap-2 flex-wrap">
              {periodOptions.map((period) => (
                <button
                  key={period}
                  onClick={() => setPeriodFilter(period)}
                  className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                    periodFilter === period
                      ? 'bg-[#3182f6] text-white'
                      : 'bg-[#f8f9fa] text-[#8b95a1] hover:bg-[#e9ecef]'
                  }`}
                >
                  {period}
                </button>
              ))}
            </div>
          </div>

          <div>
            <h4 className="font-medium text-[#191f28] mb-3">ì¦ê¶Œì‚¬</h4>
            <div className="flex gap-2 flex-wrap">
              {analystOptions.map((option) => (
                <button
                  key={option.name}
                  onClick={() => setAnalystFilter(option.name)}
                  className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                    analystFilter === option.name
                      ? 'bg-[#3182f6] text-white'
                      : 'bg-[#f8f9fa] text-[#8b95a1] hover:bg-[#e9ecef]'
                  }`}
                >
                  {option.name}
                  {option.count && `(${option.count})`}
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* ëª©í‘œê°€ ì°¨íŠ¸ ì˜ì—­ (ê°œì„ ë¨) */}
      <div className="bg-white rounded-lg border border-[#e8e8e8] p-6">
        <h4 className="font-medium text-[#191f28] mb-4">ëª©í‘œê°€ ì¶”ì´ & ì• ë„ë¦¬ìŠ¤íŠ¸ ì˜ê²¬ ({filteredSignals.length}ê°œ)</h4>
        <div className="relative h-80 bg-[#f8f9fa] rounded-lg overflow-hidden">
          <svg className="w-full h-full" viewBox="0 0 400 200">
            {/* ë°°ê²½ ê²©ì */}
            <defs>
              <pattern id="analystGrid" width="40" height="20" patternUnits="userSpaceOnUse">
                <path d="M 40 0 L 0 0 0 20" fill="none" stroke="#e8e8e8" strokeWidth="1"/>
              </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#analystGrid)" />
            
            {/* í˜„ì¬ ì£¼ê°€ ë¼ì¸ */}
            <line x1="0" y1="120" x2="400" y2="120" stroke="#666" strokeWidth="2" strokeDasharray="5,5" />
            <text x="10" y="115" className="text-xs fill-gray-600">í˜„ì¬ê°€ 68,500ì›</text>
            
            {/* í‰ê·  ëª©í‘œê°€ ë¼ì¸ */}
            <line x1="0" y1="80" x2="400" y2="80" stroke="#10B981" strokeWidth="2" strokeDasharray="3,3" />
            <text x="10" y="75" className="text-xs fill-green-600">í‰ê·  ëª©í‘œê°€ {avgTargetPrice.toLocaleString()}ì›</text>
            
            {/* ëª©í‘œê°€ íŠ¸ë Œë“œ ë¼ì¸ */}
            <path
              d="M 50 100 L 120 85 L 200 75 L 280 80 L 350 70"
              fill="none"
              stroke="#10B981"
              strokeWidth="3"
            />
            
            {/* ì• ë„ë¦¬ìŠ¤íŠ¸ ëª©í‘œê°€ ì ë“¤ */}
            {filteredSignals.map((signal, index) => {
              const x = 50 + (index * 75); 
              const targetPriceNum = parseInt(signal.targetPrice.replace(/[,ì›]/g, ''));
              const y = 200 - (targetPriceNum / 80000) * 160; 
              
              return (
                <g key={index}>
                  <circle 
                    cx={x} 
                    cy={y} 
                    r="10" 
                    fill={getTargetPriceColor(signal.firm)} 
                    stroke="white" 
                    strokeWidth="2"
                    className="cursor-pointer"
                  />
                  <title>
                    {signal.firm} {signal.analyst} - {signal.targetPrice} ({signal.signal})
                  </title>
                </g>
              );
            })}
          </svg>
          
          {/* ë²”ë¡€ (ê°œì„ ë¨) */}
          <div className="absolute top-3 right-3 bg-white/90 backdrop-blur-sm rounded-lg p-4 text-xs">
            <div className="font-medium mb-2">ì¦ê¶Œì‚¬ë³„ ëª©í‘œê°€</div>
            <div className="space-y-1">
              {filteredSignals.map((signal, index) => (
                <div key={index} className="flex items-center gap-2">
                  <span 
                    className="w-3 h-3 rounded-full" 
                    style={{ backgroundColor: getTargetPriceColor(signal.firm) }}
                  ></span>
                  <span>{signal.firm.replace('ì¦ê¶Œ', '')} {signal.targetPrice}</span>
                </div>
              ))}
            </div>
            <div className="mt-3 pt-2 border-t border-gray-200">
              <div className="font-medium text-green-600">
                í‰ê· : {avgTargetPrice.toLocaleString()}ì›
              </div>
              <div className="text-gray-600">
                ìƒìŠ¹ì—¬ë ¥: {((avgTargetPrice - 68500) / 68500 * 100).toFixed(1)}%
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* ì• ë„ë¦¬ìŠ¤íŠ¸ ì˜ê²¬ í…Œì´ë¸” */}
      <div className="bg-white rounded-lg border border-[#e8e8e8] overflow-hidden">
        <div className="p-6 border-b border-[#e8e8e8]">
          <h4 className="font-medium text-[#191f28]">ì• ë„ë¦¬ìŠ¤íŠ¸ ì˜ê²¬ ì´ë ¥</h4>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-[#f8f9fa]">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ë‚ ì§œ</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ì• ë„ë¦¬ìŠ¤íŠ¸</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ì˜ê²¬</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ëª©í‘œê°€</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ìƒìŠ¹ì—¬ë ¥</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">í•µì‹¬ë…¼ê±°</th>
                <th className="px-4 py-3 text-left text-sm font-medium text-[#8b95a1]">ì ì¤‘ë¥ </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[#f0f0f0]">
              {filteredSignals.map((signal, index) => (
                <tr key={index} className="hover:bg-[#f8f9fa]">
                  <td className="px-4 py-4 text-sm text-[#191f28]">
                    {new Date(signal.date).toLocaleDateString('ko-KR', { 
                      month: 'short', 
                      day: 'numeric' 
                    })}
                  </td>
                  <td className="px-4 py-4 text-sm font-medium text-[#191f28]">
                    <div>{signal.analyst}</div>
                    <div className="text-xs text-[#8b95a1]">{signal.firm}</div>
                  </td>
                  <td className="px-4 py-4">
                    <div className="flex items-center gap-2">
                      <span className="text-lg">{getSignalEmoji(signal.signal)}</span>
                      <span className={`px-2 py-1 rounded text-xs font-medium ${getSignalColor(signal.signal)}`}>
                        {signal.signal}
                      </span>
                    </div>
                  </td>
                  <td className="px-4 py-4 text-sm font-bold text-[#191f28]">
                    {signal.targetPrice}
                  </td>
                  <td className="px-4 py-4 text-sm font-medium">
                    <span className={signal.upside.startsWith('+') ? 'text-red-600' : 'text-blue-600'}>
                      {signal.upside}
                    </span>
                  </td>
                  <td className="px-4 py-4 text-sm text-[#191f28] max-w-xs">
                    <div className="truncate" title={signal.quote}>{signal.quote}</div>
                  </td>
                  <td className="px-4 py-4 text-sm font-medium text-green-600">
                    {signal.accuracy}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}